<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Public Dev Diary — TempéBreault</title>
  <style>
    :root{
      --bg:#071428;
      --panel:#0b3b73;
      --muted:#a9c6ff;
      --glass: rgba(255,255,255,0.04);
      --accent: #0b6efd;
      --accent-2: #4ea3ff;
      --card:#06203a;
      --text: #eaf2ff;
      --danger: #ff6b6b;
      --success:#34d399;
      --max-width:1100px;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg),#021022 80%);color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding:32px;display:flex;align-items:flex-start;justify-content:center;
    }

    .app{
      width:100%;max-width:var(--max-width);
      background:linear-gradient(180deg, rgba(11,110,253,0.05), rgba(10,25,45,0.6));
      border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 8px 30px rgba(2,6,23,0.6);
    }

    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{display:flex;gap:12px;align-items:center}
    .logo{
      width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(11,110,253,0.2)
    }
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600}
    .btn.small{padding:6px 8px;font-size:13px}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none}

    .meta{display:flex;gap:10px;align-items:center}
    .indicator{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(11,110,253,0.25)}

    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}

    /* left column */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .search{display:flex;gap:8px;margin-bottom:12px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}

    /* legend scaled down ~25% */
    .legend{margin-top:8px;font-size:0.85rem}
    .legend .row{display:flex;gap:8px;align-items:center;padding:6px 6px;border-radius:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 7px;border-radius:999px;font-weight:700;font-size:11px}
    .badge.released{background:linear-gradient(90deg,#052b48,#0b6efd);box-shadow:0 6px 12px rgba(11,110,253,0.10)}
    .badge.active{background:linear-gradient(90deg,#044169,#3aa0ff);}
    .badge.inprogress{background:linear-gradient(90deg,#052b48,#1b8cff);}
    .badge.archived{background:linear-gradient(90deg,#0b3b73,#133b4f);opacity:0.85}

    .stats{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .stat{display:flex;justify-content:space-between;font-size:13px;padding:8px;border-radius:8px;background:var(--glass)}

    /* right column */
    .content{display:flex;flex-direction:column;gap:12px}
    section.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .card h2{margin:0;font-size:15px}
    .card .sub{color:var(--muted);font-size:13px;margin-top:6px}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{font-size:12px;text-align:left;padding:10px 6px;color:var(--muted);border-bottom:1px dashed rgba(255,255,255,0.03)}
    tbody tr{transition:background 0.15s;border-radius:8px}
    tbody tr:hover{background:rgba(255,255,255,0.02)}
    td{padding:12px 6px;vertical-align:middle}
    .name{font-weight:700}
    .meta-tags{font-size:12px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap}

    /* make notes wrap and breathe easier in In Development */
    td .note{display:block;white-space:normal;word-break:break-word;max-width:52ch;color:var(--muted);margin-top:6px;line-height:1.35}

    .progress{height:8px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;width:140px}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:6px}

    .actions{display:flex;gap:8px;align-items:center}
    .tiny{padding:6px;border-radius:8px;font-size:13px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    /* hide by default; shown only when unlocked (JS toggles .show) */
    .locked-hidden{display:none}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,5,13,0.6),rgba(1,5,13,0.8));display:none;align-items:center;justify-content:center;padding:24px;z-index:60}
    .modal-backdrop.show{display:flex}
    .modal{width:100%;max-width:720px;background:linear-gradient(180deg,#021428,#041828);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .modal .row{display:flex;gap:8px}
    .modal label{font-size:13px;color:var(--muted)}
    .form-control{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}

    .history-list{max-height:320px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);}
    .history-item{padding:8px;border-radius:8px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
    .history-item pre{white-space:pre-wrap;margin:6px 0;max-height:200px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}

    /* responsive */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
      .title{flex-direction:column;align-items:flex-start}
      .legend{font-size:0.9rem}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Public Development Diary">
    <header>
      <div class="title">
        <div class="logo">DD</div>
        <div>
          <h1>Public Dev Diary</h1>
          <p class="lead">Publicly viewable dev diary of TempéBreault</p>
        </div>
      </div>

      <div class="controls">
        <div class="indicator"><span class="dot" aria-hidden></span><span id="modeLabel">Read-only</span></div>
        <button class="btn small" id="unlockBtn">Unlock (passkey)</button>

        <!-- these are hidden to public (JS toggles .locked-hidden when unlocked) -->
        <button class="btn small ghost locked-hidden" id="exportBtn">Export JSON</button>
        <button class="btn small ghost locked-hidden" id="importBtn">Import JSON</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none">
      </div>
    </header>

    <div class="grid">
      <aside class="panel">
        <div class="search">
          <input id="searchInput" placeholder="Search projects, tags, notes..." />
          <button id="addNewBtn" class="btn small primary locked-hidden" title="Add project (requires unlock)">+ New</button>
        </div>

        <div class="legend" aria-hidden="false">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Legend</strong><span class="note">What each status means</span></div>
          <div class="row" style="margin-top:8px"><div class="badge released">Released</div><div class="note">Product complete and available (may receive updates).</div></div>
          <div class="row"><div class="badge active">Developed • Active</div><div class="note">Released and actively maintained.</div></div>
          <div class="row"><div class="badge inprogress">In development</div><div class="note">Under construction — not released yet.</div></div>
          <div class="row"><div class="badge archived">Archived</div><div class="note">No longer maintained.</div></div>
        </div>

        <div class="stats">
          <div class="stat"><div>Projects</div><div id="statTotal">0</div></div>
          <div class="stat"><div>Developed / Released</div><div id="statDev">0</div></div>
          <div class="stat"><div>In Development</div><div id="statIn">0</div></div>
          <div class="stat"><div>Archived</div><div id="statArc">0</div></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;flex-direction:column">
          <button id="undoBtn" class="btn small ghost locked-hidden">Undo last change</button>
          <button id="resetBtn" class="btn small ghost locked-hidden">Reset defaults</button>
        </div>
      </aside>

      <main class="content">
        <section class="card" aria-labelledby="developedHeading">
          <h2 id="developedHeading">Developed / Released</h2>
          <div class="sub">Stable projects and products (includes items under active maintenance)</div>
          <table id="developedTable" aria-describedby="developedHeading">
            <thead>
              <tr><th>Project</th><th>Tags &amp; Notes</th><th>Progress</th><th>Version</th><th style="width:160px">Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="card" aria-labelledby="devHeading">
          <h2 id="devHeading">In Development</h2>
          <div class="sub">Currently being worked on — expect frequent updates and changes</div>
          <table id="devTable">
            <thead>
              <tr><th>Project</th><th>Tags &amp; Notes</th><th>Progress</th><th>Version</th><th style="width:160px">Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

      </main>
    </div>

    <!-- modal: edit/create & history -->
    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal" role="document" aria-labelledby="modalTitle">
        <h3 id="modalTitle">Edit project</h3>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label class="note">Name</label>
            <input id="f_name" class="form-control" />
          </div>
          <div style="width:170px">
            <label class="note">Status</label>
            <select id="f_status" class="form-control">
              <option value="released">Released</option>
              <option value="developed-active">Developed • Active</option>
              <option value="in-development">In Development</option>
              <option value="archived">Archived</option>
            </select>
          </div>
          <div style="width:140px">
            <label class="note">Version</label>
            <input id="f_version" class="form-control" placeholder="v1.0.0" />
          </div>
          <div style="width:120px">
            <label class="note">Progress %</label>
            <input id="f_progress" class="form-control" type="number" min="0" max="100" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="note">Description / Notes</label>
          <textarea id="f_notes" rows="4" class="form-control"></textarea>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="modalCancel">Cancel</button>
          <button class="btn primary" id="modalSave">Save</button>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0">

        <div>
          <strong>History</strong>
          <div class="history-list" id="historyList" aria-live="polite">
            <!-- history items injected -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// --- Config & storage ---
const PASSKEY = 'tempebreault';
const LS_KEY = 'devDiary.projects.v1';
const LS_UNLCK = 'devDiary.unlocked.v1';
const LS_UNDO = 'devDiary.undo.v1';

// Initial seed
const DEFAULT_PROJECTS = [
  { id:'expiry-tracker', name:'Expiry Tracker', status:'developed-active', progress:100, version:'1.2.0', notes:'Developed and active — ongoing improvements and bug fixes.', tags:['utility','tracking'], createdAt: Date.now()-1000*60*60*24*60, history:[] },
  { id:'word-search', name:'Word Search', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['puzzle'], createdAt: Date.now()-1000*60*60*24*200, history:[] },
  { id:'plumbers-handbook', name:'Plumbers handbook', status:'in-development', progress:28, version:'0.3.0', notes:'Unfinished — core reference content being drafted.', tags:['reference','manual'], createdAt: Date.now()-1000*60*60*24*30, history:[] },
  { id:'keyboard-karate', name:'Keyboard Karate', status:'released', progress:100, version:'1.0.1', notes:'Product complete.', tags:['game','typing'], createdAt: Date.now()-1000*60*60*24*400, history:[] },
  { id:'emoji-game', name:'Emoji Game', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['casual','game'], createdAt: Date.now()-1000*60*60*24*120, history:[] },
  { id:'reflex-reactor', name:'Reflex Reactor', status:'released', progress:100, version:'1.1.0', notes:'Product complete.', tags:['game','reflex'], createdAt: Date.now()-1000*60*60*24*90, history:[] },
  { id:'word-typing-simulator', name:'Word Typing Simulator', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['simulator','typing'], createdAt: Date.now()-1000*60*60*24*150, history:[] },
  { id:'destiny-orb', name:'Destiny Orb', status:'in-development', progress:12, version:'0.1.0', notes:'**NEW** In development — Magic 8 Ball inspired. Demo phase.', tags:['new','demo','game'], createdAt: Date.now()-1000*60*60*24*2, history:[] }
];

let projects = loadProjects();
let unlocked = sessionStorage.getItem(LS_UNLCK) === '1';
let undoStack = loadJSON(LS_UNDO) || [];

// DOM refs
const developedBody = document.querySelector('#developedTable tbody');
const devBody = document.querySelector('#devTable tbody');
const statTotal = document.getElementById('statTotal');
const statDev = document.getElementById('statDev');
const statIn = document.getElementById('statIn');
const statArc = document.getElementById('statArc');
const unlockBtn = document.getElementById('unlockBtn');
const modeLabel = document.getElementById('modeLabel');
const addNewBtn = document.getElementById('addNewBtn');
const searchInput = document.getElementById('searchInput');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const f_name = document.getElementById('f_name');
const f_status = document.getElementById('f_status');
const f_version = document.getElementById('f_version');
const f_progress = document.getElementById('f_progress');
const f_notes = document.getElementById('f_notes');
const modalSave = document.getElementById('modalSave');
const modalCancel = document.getElementById('modalCancel');
const historyList = document.getElementById('historyList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const fileInput = document.getElementById('fileInput');
const undoBtn = document.getElementById('undoBtn');
const resetBtn = document.getElementById('resetBtn');

let editingId = null;

// helpers
function loadJSON(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadProjects(){
  const raw = loadJSON(LS_KEY);
  if(!raw){ localStorage.setItem(LS_KEY, JSON.stringify(DEFAULT_PROJECTS)); return JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); }
  return raw;
}

function saveUndoSnapshot(){
  undoStack.push(JSON.parse(JSON.stringify(projects)));
  if(undoStack.length>30) undoStack.shift();
  saveJSON(LS_UNDO, undoStack);
}

function persist(){
  saveJSON(LS_KEY, projects);
  render();
}

function uid(){ return 'p_'+Math.random().toString(36).slice(2,9); }
function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function statusLabel(s){
  switch(s){
    case 'released': return 'Released';
    case 'developed-active': return 'Developed - Active';
    case 'in-development': return 'In development';
    case 'archived': return 'Archived';
    default: return s;
  }
}

// render UI visibility for locked/unlocked features
function updateLockedUI(){
  // header import/export buttons
  document.querySelectorAll('.locked-hidden').forEach(el=>{
    el.style.display = unlocked ? '' : 'none';
  });
  // update mode label and unlock button text
  modeLabel.textContent = unlocked ? 'Edit mode' : 'Read-only';
  unlockBtn.textContent = unlocked ? 'Lock (logout)' : 'Unlock (passkey)';
}

// rendering
function render(){
  updateLockedUI();

  const total = projects.length;
  const devCount = projects.filter(p=>p.status==='released' || p.status==='developed-active').length;
  const inCount = projects.filter(p=>p.status==='in-development').length;
  const arcCount = projects.filter(p=>p.status==='archived').length;
  statTotal.textContent = total; statDev.textContent = devCount; statIn.textContent = inCount; statArc.textContent = arcCount;

  const q = (searchInput.value||'').trim().toLowerCase();
  const matches = p=>{
    if(!q) return true;
    return [p.name,(p.notes||''),(p.tags||[]).join(' ')].join(' ').toLowerCase().includes(q);
  }

  developedBody.innerHTML=''; devBody.innerHTML='';

  const developed = projects.filter(p=>p.status==='released' || p.status==='developed-active' || p.status==='archived').filter(matches).sort((a,b)=>b.createdAt - a.createdAt);
  const indev = projects.filter(p=>p.status==='in-development').filter(matches).sort((a,b)=>b.progress - a.progress);

  developed.forEach(p => developedBody.appendChild(rowFor(p)));
  indev.forEach(p => devBody.appendChild(rowFor(p)));
}

function rowFor(p){
  const tr = document.createElement('tr');

  // project cell: name + notes (notes now wrap nicely)
  const tdName = document.createElement('td');
  tdName.innerHTML = `<div class="name">${escapeHtml(p.name)} ${p.tags && p.tags.includes('new')? '<span style="font-size:11px;margin-left:8px;padding:4px 6px;border-radius:6px;background:linear-gradient(90deg,var(--accent-2),var(--accent));font-weight:800;color:#001">NEW</span>':''}</div><div class="note">${escapeHtml(p.notes||'')}</div>`;
  tr.appendChild(tdName);

  // tags cell
  const tdTags = document.createElement('td');
  tdTags.innerHTML = `<div class="meta-tags">${(p.tags||[]).map(t=>`<span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;font-weight:700">${escapeHtml(t)}</span>`).join('')}</div>`;
  tr.appendChild(tdTags);

  // progress
  const tdProg = document.createElement('td');
  tdProg.innerHTML = `<div class="progress" aria-hidden><i style="width:${Math.max(0,Math.min(100,p.progress||0))}%"></i></div><div style="font-size:12px;color:var(--muted);margin-top:6px">${p.progress||0}%</div>`;
  tr.appendChild(tdProg);

  // version
  const tdVer = document.createElement('td');
  tdVer.innerHTML = `<div style="font-weight:700">${escapeHtml(p.version||'—')}</div><div class="note">${new Date(p.createdAt).toLocaleDateString()}</div>`;
  tr.appendChild(tdVer);

  // actions: only HISTORY is shown to public. other controls displayed only when unlocked.
  const tdAct = document.createElement('td');
  tdAct.className = 'actions';

  // History (always visible) - opens history modal (read-only)
  const btnHist = document.createElement('button'); btnHist.className='tiny'; btnHist.title='View history'; btnHist.textContent='History';
  btnHist.addEventListener('click', () => openModal(p.id, true));
  tdAct.appendChild(btnHist);

  if(unlocked){
    // Edit
    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.className='tiny';
    btnEdit.addEventListener('click', ()=>openModal(p.id,false));
    tdAct.appendChild(btnEdit);

    // quick status change
    const sel = document.createElement('select'); sel.className='tiny'; sel.style.padding='6px';
    ['released','developed-active','in-development','archived'].forEach(s=>{
      const o = document.createElement('option'); o.value=s; o.textContent = statusLabel(s); if(p.status===s) o.selected=true; sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      saveUndoSnapshot();
      const old = {...p};
      p.status = sel.value;
      if(p.status==='released') p.progress = 100;
      p.history = p.history || []; p.history.push({when:Date.now(), who:'editor', action:`status->${p.status}`, snapshot:old});
      persist();
    });
    tdAct.appendChild(sel);

    // reorder
    const up = document.createElement('button'); up.className='tiny'; up.title='Move up'; up.textContent='↑'; up.addEventListener('click',()=>moveProject(p.id,-1)); tdAct.appendChild(up);
    const down = document.createElement('button'); down.className='tiny'; down.title='Move down'; down.textContent='↓'; down.addEventListener('click',()=>moveProject(p.id,1)); tdAct.appendChild(down);

    // delete
    const del = document.createElement('button'); del.className='tiny'; del.style.borderColor='rgba(255,100,100,0.12)'; del.textContent='Delete';
    del.addEventListener('click', ()=>{
      if(!confirm('Delete this project? This cannot be undone except via Undo (if available).')) return;
      saveUndoSnapshot(); projects = projects.filter(x=>x.id!==p.id); persist();
    });
    tdAct.appendChild(del);
  }

  tr.appendChild(tdAct);
  return tr;
}

// modal / editor
function openModal(id=null, viewHistoryOnly=false){
  editingId = id;
  if(id){
    const p = projects.find(x=>x.id===id);
    if(!p) return;
    modalTitle.textContent = (viewHistoryOnly? 'History for ' : 'Edit ') + p.name;
    f_name.value = p.name; f_status.value = p.status; f_version.value = p.version; f_progress.value = p.progress||0; f_notes.value = p.notes||'';
    renderHistory(p.history);
  } else {
    modalTitle.textContent = 'Create new project'; f_name.value=''; f_status.value='in-development'; f_version.value='0.1.0'; f_progress.value=10; f_notes.value=''; historyList.innerHTML='';
  }

  // when viewing history only, disable save and editing of fields
  modalSave.disabled = viewHistoryOnly || !unlocked;
  f_name.disabled = viewHistoryOnly || !unlocked;
  f_status.disabled = viewHistoryOnly || !unlocked;
  f_version.disabled = viewHistoryOnly || !unlocked;
  f_progress.disabled = viewHistoryOnly || !unlocked;
  f_notes.disabled = viewHistoryOnly || !unlocked;

  modalBackdrop.classList.add('show');

  // trap keyboard input inside modal to keep history truly read-only: prevent typing when viewHistoryOnly
  if(viewHistoryOnly){
    modalBackdrop.addEventListener('keydown', preventTypingWhileHistory);
  } else {
    modalBackdrop.removeEventListener('keydown', preventTypingWhileHistory);
  }
}

function closeModal(){
  modalBackdrop.classList.remove('show');
  editingId = null;
  modalBackdrop.removeEventListener('keydown', preventTypingWhileHistory);
}

function preventTypingWhileHistory(e){
  // allow navigation keys, copy (ctrl/cmd+c), selection but block printable characters, backspace and delete
  const blocked = ['Backspace','Delete'];
  if(blocked.includes(e.key)) { e.preventDefault(); return; }
  if(e.ctrlKey || e.metaKey) {
    // allow common combos (copy/select)
    return;
  }
  // block visible character input
  if(e.key.length === 1){ e.preventDefault(); }
}

// render history into modal (read-only)
function renderHistory(arr){
  historyList.innerHTML = '';
  (arr||[]).slice().reverse().forEach(h=>{
    const el = document.createElement('div'); el.className='history-item';
    const action = escapeHtml(h.action || 'change');
    const who = escapeHtml(h.who || '—');
    const when = new Date(h.when).toLocaleString();
    const snap = escapeHtml(JSON.stringify(h.snapshot||{}, null, 2));
    el.innerHTML = `<div style="font-weight:700;color:var(--text)">${action}</div><div style="font-size:12px;color:var(--muted)">${when} — ${who}</div><div style="margin-top:6px;font-size:13px">Snapshot:<pre>${snap}</pre></div>`;
    // ensure pre is not editable
    el.querySelectorAll('pre').forEach(p => p.contentEditable = 'false');
    historyList.appendChild(el);
  });
  if(!(arr||[]).length) historyList.innerHTML = '<div class="note">No history yet for this project.</div>';
}

// modal button handlers
document.getElementById('modalCancel').addEventListener('click', ()=> closeModal());
modalBackdrop.addEventListener('click', (e) => { if(e.target === modalBackdrop) closeModal(); });

document.getElementById('modalSave').addEventListener('click', ()=>{
  const name = f_name.value.trim(); if(!name){ alert('Name required'); return; }
  const status = f_status.value; const version = f_version.value.trim(); const progress = Number(f_progress.value)||0; const notes = f_notes.value.trim();
  if(editingId){
    saveUndoSnapshot();
    const p = projects.find(x=>x.id===editingId);
    if(!p) return;
    const old = JSON.parse(JSON.stringify(p));
    p.name = name; p.status = status; p.version = version; p.progress = progress; p.notes = notes; p.tags = p.tags || [];
    p.history = p.history || []; p.history.push({when:Date.now(), who:'editor', action:'updated', snapshot:old});
  } else {
    saveUndoSnapshot();
    const id = slugify(name) || uid();
    const newP = { id, name, status, version, progress, notes, tags:[], createdAt:Date.now(), history:[{when:Date.now(),who:'editor',action:'created'}] };
    projects.unshift(newP);
  }
  persist(); closeModal();
});

// unlock / lock
unlockBtn.addEventListener('click', ()=>{
  if(unlocked){
    unlocked = false;
    sessionStorage.removeItem(LS_UNLCK);
    render();
    return;
  }
  const val = prompt('Enter passkey to unlock edit mode:');
  if(val === PASSKEY){
    unlocked = true;
    sessionStorage.setItem(LS_UNLCK, '1');
    alert('Unlocked — you may now edit.');
    render();
  } else {
    alert('Incorrect passkey.');
  }
});

// add new (only when unlocked)
addNewBtn.addEventListener('click', ()=>{
  if(!unlocked){ alert('Unlock first to create or edit projects.'); return; }
  openModal(null,false);
});

// search
searchInput.addEventListener('input', ()=> render());

// export / import handlers (buttons hidden until unlocked)
exportBtn.addEventListener('click', ()=>{
  if(!unlocked) return;
  const data = JSON.stringify({ exportedAt:Date.now(), projects }, null, 2);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dev-diary-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> { if(!unlocked) return; fileInput.click(); });

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    if(!parsed.projects) throw new Error('Invalid file format');
    if(!confirm('Import will replace current projects. Continue?')) return;
    saveUndoSnapshot(); projects = parsed.projects; persist(); alert('Import complete.');
  } catch(err){ alert('Import failed: ' + err.message); }
  fileInput.value = '';
});

// undo & reset (only available when unlocked, buttons are hidden when locked)
undoBtn.addEventListener('click', ()=>{
  if(!unlocked) return;
  if(!undoStack || !undoStack.length){ alert('Nothing to undo'); return; }
  const prev = undoStack.pop(); projects = prev; saveJSON(LS_UNDO, undoStack); persist(); alert('Reverted last change');
});

resetBtn.addEventListener('click', ()=>{
  if(!unlocked) return;
  if(!confirm('Reset to default seeded projects? This will overwrite current projects.')) return;
  saveUndoSnapshot(); projects = JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); persist(); alert('Reset complete.');
});

function moveProject(id, dir){
  const idx = projects.findIndex(p=>p.id===id); if(idx===-1) return; const to = idx+dir; if(to<0||to>=projects.length) return; saveUndoSnapshot(); const [itm] = projects.splice(idx,1); projects.splice(to,0,itm); persist();
}

// initial render
render();

// expose some helpers for debugging (optional)
window.__devDiary = {
  get projects(){ return projects; },
  save: ()=> persist(),
  unlock: ()=> { sessionStorage.setItem(LS_UNLCK,'1'); unlocked=true; render(); }
};
</script>
</body>
</html>
