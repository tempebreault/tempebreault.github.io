<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Public Dev Diary — TempéBreault</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg-0:#061227;
      --bg-1:#071428;
      --panel:#09345e;
      --muted:#b9d5ff;
      --glass: rgba(255,255,255,0.04);
      --accent: #0b6efd;
      --accent-2: #4ea3ff;
      --card:#071d34;
      --text: #eaf2ff;
      --success:#34d399;
      --danger:#ff6b6b;
      --max-width:1200px;
      --radius:12px;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
      --transition: 220ms cubic-bezier(.2,.9,.2,1);
      --header-height:64px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      font-size:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:linear-gradient(180deg,var(--bg-1),#021022 88%);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex;align-items:flex-start;justify-content:center;padding:20px;
    }

    /* APP shell */
    .app{
      width:100%; max-width:var(--max-width);
      background:linear-gradient(180deg, rgba(14,57,100,0.06), rgba(8,18,30,0.6));
      border-radius:14px; border:1px solid rgba(255,255,255,0.03);
      box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column;
    }

    /* header - sticky */
    header.app-header{
      height:var(--header-height); display:flex; align-items:center; gap:12px;
      padding:10px 16px; position:sticky; top:0; z-index:40; background:linear-gradient(180deg, rgba(2,9,20,0.5), rgba(3,12,22,0.6));
      backdrop-filter: blur(6px);
    }
    .title {display:flex;gap:12px;align-items:center;flex:1;min-width:0}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:16px;box-shadow:0 6px 18px rgba(11,110,253,0.18)}
    .title h1{margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title p{margin:0;color:var(--muted);font-size:12px;opacity:0.95}

    .header-controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600;transition:all var(--transition)}
    .btn.small{padding:6px 8px;font-size:13px}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none}
    .btn:active{transform:translateY(1px)}
    .tooltip{position:relative}
    .tooltip[data-tip]:hover::after{
      content:attr(data-tip); position:absolute; bottom:calc(100% + 8px); right:0; background:rgba(2,6,23,0.9); padding:6px 8px;border-radius:6px;font-size:12px;color:var(--muted);white-space:nowrap;z-index:60;box-shadow:0 6px 18px rgba(2,6,23,0.6)
    }

    /* layout: resizable split */
    .shell{display:flex; height:calc(100% - var(--header-height)); min-height:540px;}
    .sidebar{width:320px; min-width:200px; max-width:540px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); padding:14px; border-right:1px solid rgba(255,255,255,0.02); overflow:auto; transition:width 220ms}
    .divider{width:8px; cursor:col-resize; background:transparent; display:flex; align-items:center; justify-content:center}
    .divider .bar{width:2px;height:40%;background:rgba(255,255,255,0.03);border-radius:2px}
    .main{flex:1; padding:14px; overflow:auto;}

    /* collapsible on small screens */
    .sidebar.collapsed{width:0; padding:0; border-right:none; overflow:hidden}
    .sidebar.collapsed + .divider{display:none}

    /* search + compact toggles */
    .search{display:flex; gap:8px; margin-bottom:12px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none}
    .search input:focus{box-shadow:0 6px 20px rgba(11,110,253,0.06); border-color:var(--accent)}

    .legend{margin-top:8px;font-size:0.86rem}
    .legend .row{display:flex;gap:8px;align-items:center;padding:6px 6px;border-radius:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 7px;border-radius:999px;font-weight:700;font-size:11px}
    .stats{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .stat{display:flex;justify-content:space-between;font-size:13px;padding:8px;border-radius:8px;background:var(--glass)}

    /* tables */
    .content .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px}
    .card h2{margin:0;font-size:15px}
    .card .sub{color:var(--muted);font-size:13px;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{font-size:13px;text-align:left;padding:12px 8px;color:var(--muted);border-bottom:1px dashed rgba(255,255,255,0.03);cursor:pointer;user-select:none}
    thead th.sort-asc::after{content:" ▲";font-size:11px;color:var(--muted)}
    thead th.sort-desc::after{content:" ▼";font-size:11px;color:var(--muted)}
    tbody tr{transition:background var(--transition);border-radius:8px}
    tbody tr:hover{background:rgba(255,255,255,0.02)}
    td{padding:12px 8px;vertical-align:middle}
    .name{font-weight:700}
    .meta-tags{font-size:12px;color:var(--muted);display:flex;gap:6px;flex-wrap:wrap}
    td .note{display:block;white-space:normal;word-break:break-word;max-width:52ch;color:var(--muted);margin-top:6px;line-height:1.35}

    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;width:140px}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:6px}
    .actions{display:flex;gap:8px;align-items:center}
    .tiny{padding:6px;border-radius:8px;font-size:13px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    /* compact mode */
    .compact table td{padding:8px 6px}
    .compact .panel, .compact .card{padding:8px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg,rgba(1,5,13,0.6),rgba(1,5,13,0.8));display:none;align-items:center;justify-content:center;padding:16px;z-index:90}
    .modal-backdrop.show{display:flex}
    .modal{width:100%;max-width:820px;background:linear-gradient(180deg,#021428,#041828);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .form-control{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}

    .history-list{max-height:320px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);}
    .history-item{padding:8px;border-radius:8px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
    .history-item pre{white-space:pre-wrap;margin:6px 0;max-height:200px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}

    /* mobile adjustments */
    @media (max-width:900px){
      body{padding:12px}
      .sidebar{position:fixed;left:0;top:var(--header-height);bottom:0;z-index:60;height:calc(100vh - var(--header-height));transform:translateX(0);transition:transform 220ms}
      .sidebar.overlay{background:linear-gradient(180deg, rgba(4,20,40,0.96), rgba(2,9,20,0.98));box-shadow:0 20px 40px rgba(2,6,23,0.6)}
      .sidebar.hidden{transform:translateX(-110%)}
      .divider{display:none}
      .shell{flex-direction:column}
      .main{padding:12px}
      thead th{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Public Dev Diary">
    <header class="app-header" role="banner">
      <div class="title" role="heading" aria-level="1">
        <div class="logo" aria-hidden>DD</div>
        <div style="min-width:0">
          <h1>Public Dev Diary</h1>
          <p class="lead">Publicly viewable dev diary of TempéBreault</p>
        </div>
      </div>

      <div class="header-controls" role="toolbar" aria-label="Top controls">
        <button id="sidebarToggle" class="btn small tooltip" data-tip="Toggle sidebar (mobile)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></button>
        <div class="indicator" aria-hidden><span style="width:10px;height:10px;border-radius:50%;background:var(--accent);display:inline-block;margin-right:8px;box-shadow:0 0 8px rgba(11,110,253,0.25)"></span><span id="modeLabel">Read-only</span></div>
        <button id="compactToggle" class="btn small ghost tooltip" data-tip="Compact mode (toggle)">Compact</button>
        <button id="undoViewerBtn" class="btn small ghost locked-hidden tooltip" data-tip="View undo stack">Undo</button>
        <button id="unlockBtn" class="btn small primary tooltip" data-tip="Enter passkey to edit">Unlock</button>
        <button id="exportBtnHead" class="btn small ghost locked-hidden" style="display:none">Export</button>
      </div>
    </header>

    <div class="shell" role="main">
      <aside class="sidebar" id="sidebar" aria-label="Sidebar">
        <div class="search" role="search">
          <input id="searchInput" aria-label="Search projects" placeholder="Search projects, tags, notes..." />
          <button id="addNewBtn" class="btn small primary locked-hidden" title="Add project (requires unlock)" style="display:none">+ New</button>
        </div>

        <div class="legend" aria-hidden="false">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Legend</strong><span style="font-size:12px;color:var(--muted)">What each status means</span></div>
          <div class="row" style="margin-top:8px"><div class="badge released">Released</div><div class="note" style="margin-left:6px">Complete & available.</div></div>
          <div class="row"><div class="badge active">Developed • Active</div><div class="note" style="margin-left:6px">Maintained & updated.</div></div>
          <div class="row"><div class="badge inprogress">In development</div><div class="note" style="margin-left:6px">Under construction.</div></div>
          <div class="row"><div class="badge archived">Archived</div><div class="note" style="margin-left:6px">No longer maintained.</div></div>
        </div>

        <div class="stats" aria-hidden="false" style="margin-top:10px">
          <div class="stat"><div>Projects</div><div id="statTotal">0</div></div>
          <div class="stat"><div>Developed / Released</div><div id="statDev">0</div></div>
          <div class="stat"><div>In Development</div><div id="statIn">0</div></div>
          <div class="stat"><div>Archived</div><div id="statArc">0</div></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;flex-direction:column">
          <button id="undoBtn" class="btn small ghost locked-hidden" style="display:none">Undo last change</button>
          <button id="resetBtn" class="btn small ghost locked-hidden" style="display:none">Reset defaults</button>
          <button id="exportBtn" class="btn small ghost locked-hidden" style="display:none">Export JSON</button>
          <button id="importBtn" class="btn small ghost locked-hidden" style="display:none">Import JSON</button>
          <input id="fileInput" type="file" accept="application/json" style="display:none">
        </div>
      </aside>

      <div class="divider" id="divider" aria-hidden="true"><div class="bar"></div></div>

      <section class="main" id="main">
        <div class="content" id="content">
          <section class="card" aria-labelledby="developedHeading">
            <h2 id="developedHeading">Developed / Released</h2>
            <div class="sub">Stable projects and products (includes items under active maintenance)</div>
            <table id="developedTable" aria-describedby="developedHeading">
              <thead>
                <tr>
                  <th data-key="name">Project</th>
                  <th data-key="tags">Tags & Notes</th>
                  <th data-key="progress">Progress</th>
                  <th data-key="version">Version</th>
                  <th style="width:180px">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <section class="card" aria-labelledby="devHeading">
            <h2 id="devHeading">In Development</h2>
            <div class="sub">Currently being worked on — expect frequent updates and changes</div>
            <table id="devTable">
              <thead>
                <tr>
                  <th data-key="name">Project</th>
                  <th data-key="tags">Tags & Notes</th>
                  <th data-key="progress">Progress</th>
                  <th data-key="version">Version</th>
                  <th style="width:180px">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>
        </div>
      </section>
    </div>

    <!-- modal: edit/create & history -->
    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal" role="document" aria-labelledby="modalTitle">
        <h3 id="modalTitle">Edit project</h3>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label class="note">Name</label>
            <input id="f_name" class="form-control" />
          </div>
          <div style="width:170px">
            <label class="note">Status</label>
            <select id="f_status" class="form-control">
              <option value="released">Released</option>
              <option value="developed-active">Developed • Active</option>
              <option value="in-development">In Development</option>
              <option value="archived">Archived</option>
            </select>
          </div>
          <div style="width:140px">
            <label class="note">Version</label>
            <input id="f_version" class="form-control" placeholder="v1.0.0" />
          </div>
          <div style="width:120px">
            <label class="note">Progress %</label>
            <input id="f_progress" class="form-control" type="number" min="0" max="100" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="note">Description / Notes</label>
          <textarea id="f_notes" rows="4" class="form-control"></textarea>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="modalCancel">Cancel</button>
          <button class="btn primary" id="modalSave">Save</button>
        </div>

        <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0">

        <div>
          <strong>History</strong>
          <div class="history-list" id="historyList" aria-live="polite">
            <!-- history items injected -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ============================
   Dev Diary - Enhanced Edition
   All features requested implemented:
   - mobile + desktop enhancements
   - resizable split, sortable columns, compact mode
   - keyboard shortcuts, undo viewer, import/export modals
   - autosave indicator, accessible controls
   ============================ */

/* CONFIG & STORAGE */
const PASSKEY = 'tempebreault';
const LS_KEY = 'devDiary.projects.v1';
const LS_UNLCK = 'devDiary.unlocked.v1';
const LS_UNDO = 'devDiary.undo.v1';
const LS_LAYOUT = 'devDiary.layout.v1';

/* DEFAULT PROJECTS */
const DEFAULT_PROJECTS = [
  { id:'expiry-tracker', name:'Expiry Tracker', status:'developed-active', progress:100, version:'1.2.0', notes:'Developed and active — ongoing improvements and bug fixes.', tags:['utility','tracking'], createdAt: Date.now()-1000*60*60*24*60, history:[] },
  { id:'word-search', name:'Word Search', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['puzzle'], createdAt: Date.now()-1000*60*60*24*200, history:[] },
  { id:'plumbers-handbook', name:'Plumbers handbook', status:'in-development', progress:28, version:'0.3.0', notes:'Unfinished — core reference content being drafted.', tags:['reference','manual'], createdAt: Date.now()-1000*60*60*24*30, history:[] },
  { id:'keyboard-karate', name:'Keyboard Karate', status:'released', progress:100, version:'1.0.1', notes:'Product complete.', tags:['game','typing'], createdAt: Date.now()-1000*60*60*24*400, history:[] },
  { id:'emoji-game', name:'Emoji Game', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['casual','game'], createdAt: Date.now()-1000*60*60*24*120, history:[] },
  { id:'reflex-reactor', name:'Reflex Reactor', status:'released', progress:100, version:'1.1.0', notes:'Product complete.', tags:['game','reflex'], createdAt: Date.now()-1000*60*60*24*90, history:[] },
  { id:'word-typing-simulator', name:'Word Typing Simulator', status:'released', progress:100, version:'1.0.0', notes:'Product complete.', tags:['simulator','typing'], createdAt: Date.now()-1000*60*60*24*150, history:[] },
  { id:'destiny-orb', name:'Destiny Orb', status:'in-development', progress:12, version:'0.1.0', notes:'**NEW** In development — Magic 8 Ball inspired. Demo phase.', tags:['new','demo','game'], createdAt: Date.now()-1000*60*60*24*2, history:[] }
];

/* STATE */
let projects = loadProjects();
let unlocked = sessionStorage.getItem(LS_UNLCK) === '1';
let undoStack = loadJSON(LS_UNDO) || [];
let layout = loadJSON(LS_LAYOUT) || { sidebarWidth:320, sidebarCollapsed:false, compact:false };
let autosaveTimer = null;

/* DOM Refs */
const sidebar = document.getElementById('sidebar');
const divider = document.getElementById('divider');
const main = document.getElementById('main');
const developedBody = document.querySelector('#developedTable tbody');
const devBody = document.querySelector('#devTable tbody');
const statTotal = document.getElementById('statTotal');
const statDev = document.getElementById('statDev');
const statIn = document.getElementById('statIn');
const statArc = document.getElementById('statArc');
const unlockBtn = document.getElementById('unlockBtn');
const modeLabel = document.getElementById('modeLabel');
const addNewBtn = document.getElementById('addNewBtn');
const searchInput = document.getElementById('searchInput');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const f_name = document.getElementById('f_name');
const f_status = document.getElementById('f_status');
const f_version = document.getElementById('f_version');
const f_progress = document.getElementById('f_progress');
const f_notes = document.getElementById('f_notes');
const modalSave = document.getElementById('modalSave');
const modalCancel = document.getElementById('modalCancel');
const historyList = document.getElementById('historyList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const fileInput = document.getElementById('fileInput');
const undoBtn = document.getElementById('undoBtn');
const resetBtn = document.getElementById('resetBtn');
const compactToggle = document.getElementById('compactToggle');
const sidebarToggle = document.getElementById('sidebarToggle');
const undoViewerBtn = document.getElementById('undoViewerBtn');
const exportHead = document.getElementById('exportBtnHead');

let editingId = null;
let sortState = { key: null, dir: null };

/* HELPERS */
function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null } }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadProjects(){
  const raw = loadJSON(LS_KEY);
  if(!raw){ saveJSON(LS_KEY, DEFAULT_PROJECTS); return JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); }
  return raw;
}
function uid(){ return 'p_'+Math.random().toString(36).slice(2,9); }
function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function nowStr(){ return new Date().toLocaleString(); }

/* LAYOUT PERSISTENCE */
function applyLayout(){
  sidebar.style.width = (layout.sidebarCollapsed? '0' : (layout.sidebarWidth + 'px'));
  if(layout.sidebarCollapsed) sidebar.classList.add('collapsed'); else sidebar.classList.remove('collapsed');
  document.querySelector('.app').classList.toggle('compact', layout.compact);
  // show/hide locked elements
  document.querySelectorAll('.locked-hidden').forEach(el=>{
    el.style.display = unlocked ? '' : 'none';
  });
  // header-level export btn visibility mirror
  exportHead.style.display = unlocked ? '' : 'none';
  addNewBtn.style.display = unlocked ? '' : 'none';
  undoBtn.style.display = unlocked ? '' : 'none';
  resetBtn.style.display = unlocked ? '' : 'none';
  exportBtn.style.display = unlocked ? '' : 'none';
  importBtn.style.display = unlocked ? '' : 'none';
  undoViewerBtn.style.display = unlocked ? '' : 'none';
}
function saveLayout(){ saveJSON(LS_LAYOUT, layout); }

/* UNDO SNAPSHOT */
function saveUndoSnapshot(){
  undoStack.push(JSON.parse(JSON.stringify(projects)));
  if(undoStack.length>50) undoStack.shift();
  saveJSON(LS_UNDO, undoStack);
}

/* PERSIST & AUTOSAVE INDICATOR */
const showSnackbar = (msg, ms=1500) => {
  // small temporary top-fade indicator
  let el = document.createElement('div');
  el.style.position='fixed'; el.style.top='80px'; el.style.left='50%'; el.style.transform='translateX(-50%)';
  el.style.zIndex=120; el.style.background='rgba(3,12,22,0.9)'; el.style.padding='8px 12px'; el.style.borderRadius='8px';
  el.style.boxShadow='0 8px 20px rgba(2,6,23,0.6)'; el.style.color='var(--muted)'; el.style.fontSize='13px';
  el.textContent = msg; document.body.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity 220ms'; el.style.opacity=0; setTimeout(()=>el.remove(),240) }, ms);
}

function persist(){
  saveJSON(LS_KEY, projects);
  // show autosave indicator briefly
  if(autosaveTimer) clearTimeout(autosaveTimer);
  document.title = 'Saving...';
  autosaveTimer = setTimeout(()=>{ document.title = 'Public Dev Diary — TempéBreault'; showSnackbar('Saved locally'); }, 550);
  render();
}

/* RENDERING */
function render(){
  applyLayout();
  // stats
  const total = projects.length;
  const devCount = projects.filter(p=>p.status==='released' || p.status==='developed-active').length;
  const inCount = projects.filter(p=>p.status==='in-development').length;
  const arcCount = projects.filter(p=>p.status==='archived').length;
  statTotal.textContent = total; statDev.textContent = devCount; statIn.textContent = inCount; statArc.textContent = arcCount;
  modeLabel.textContent = unlocked? 'Edit mode' : 'Read-only';
  unlockBtn.textContent = unlocked? 'Lock' : 'Unlock';

  // filtering
  const q = (searchInput.value||'').trim().toLowerCase();
  const matches = p => {
    if(!q) return true;
    return [p.name,(p.notes||''),(p.tags||[]).join(' ')].join(' ').toLowerCase().includes(q);
  };

  // sort if needed
  function sortArr(arr){
    if(!sortState.key) return arr;
    const k = sortState.key; const dir = sortState.dir === 'asc' ? 1 : -1;
    return arr.slice().sort((a,b)=>{
      let va = (a[k] || '').toString().toLowerCase();
      let vb = (b[k] || '').toString().toLowerCase();
      // if numeric progress
      if(k==='progress'){ va = Number(a.progress||0); vb = Number(b.progress||0); return (va - vb) * dir; }
      if(va < vb) return -1*dir;
      if(va > vb) return 1*dir;
      return 0;
    });
  }

  developedBody.innerHTML=''; devBody.innerHTML='';

  const developed = sortArr(projects.filter(p=>p.status==='released' || p.status==='developed-active' || p.status==='archived').filter(matches));
  const indev = sortArr(projects.filter(p=>p.status==='in-development').filter(matches));

  developed.forEach(p => developedBody.appendChild(rowFor(p)));
  indev.forEach(p => devBody.appendChild(rowFor(p)));
}

/* Create row */
function rowFor(p){
  const tr = document.createElement('tr');

  // name & notes
  const tdName = document.createElement('td');
  tdName.innerHTML = `<div class="name">${escapeHtml(p.name)} ${p.tags && p.tags.includes('new') ? '<span style="font-size:11px;margin-left:8px;padding:4px 6px;border-radius:6px;background:linear-gradient(90deg,var(--accent-2),var(--accent));font-weight:800;color:#001">NEW</span>' : ''}</div><div class="note">${escapeHtml(p.notes||'')}</div>`;
  tr.appendChild(tdName);

  // tags
  const tdTags = document.createElement('td');
  tdTags.innerHTML = `<div class="meta-tags">${(p.tags||[]).map(t=>`<span style="padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;font-weight:700">${escapeHtml(t)}</span>`).join('')}</div>`;
  tr.appendChild(tdTags);

  // progress
  const tdProg = document.createElement('td');
  tdProg.innerHTML = `<div class="progress" aria-hidden><i style="width:${Math.max(0,Math.min(100,p.progress||0))}%"></i></div><div style="font-size:12px;color:var(--muted);margin-top:6px">${p.progress||0}%</div>`;
  tr.appendChild(tdProg);

  // version
  const tdVer = document.createElement('td');
  tdVer.innerHTML = `<div style="font-weight:700">${escapeHtml(p.version||'—')}</div><div class="note">${new Date(p.createdAt).toLocaleDateString()}</div>`;
  tr.appendChild(tdVer);

  // actions (history always visible)
  const tdAct = document.createElement('td'); tdAct.className='actions';
  const btnHist = document.createElement('button'); btnHist.className='tiny tooltip'; btnHist.textContent='History'; btnHist.title='View History'; btnHist.setAttribute('aria-label','View history');
  btnHist.addEventListener('click', ()=> openModal(p.id, true));
  tdAct.appendChild(btnHist);

  if(unlocked){
    // Edit
    const btnEdit = document.createElement('button'); btnEdit.className='tiny tooltip'; btnEdit.textContent='Edit'; btnEdit.title='Edit project'; btnEdit.addEventListener('click', ()=> openModal(p.id,false));
    tdAct.appendChild(btnEdit);

    // quick status select
    const sel = document.createElement('select'); sel.className='tiny'; sel.style.padding='6px';
    ['released','developed-active','in-development','archived'].forEach(s=>{
      const o = document.createElement('option'); o.value=s; o.textContent = statusLabel(s); if(p.status===s) o.selected=true; sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      saveUndoSnapshot();
      const old = {...p}; p.status = sel.value; if(p.status==='released') p.progress = 100;
      p.history = p.history || []; p.history.push({when:Date.now(), who:'editor', action:`status->${p.status}`, snapshot:old});
      persist();
    });
    tdAct.appendChild(sel);

    // reorder up/down
    const up = document.createElement('button'); up.className='tiny tooltip'; up.textContent='↑'; up.title='Move up'; up.addEventListener('click', ()=> moveProject(p.id,-1));
    tdAct.appendChild(up);
    const down = document.createElement('button'); down.className='tiny tooltip'; down.textContent='↓'; down.title='Move down'; down.addEventListener('click', ()=> moveProject(p.id,1));
    tdAct.appendChild(down);

    // delete
    const del = document.createElement('button'); del.className='tiny tooltip'; del.textContent='Delete'; del.title='Delete project';
    del.addEventListener('click', ()=> {
      if(!confirm('Delete this project? This cannot be undone except via Undo (if available).')) return;
      saveUndoSnapshot(); projects = projects.filter(x=>x.id!==p.id); persist();
    });
    tdAct.appendChild(del);
  }

  tr.appendChild(tdAct);
  return tr;
}

/* STATUS LABEL */
function statusLabel(s){
  switch(s){
    case 'released': return 'Released';
    case 'developed-active': return 'Developed - Active';
    case 'in-development': return 'In development';
    case 'archived': return 'Archived';
    default: return s;
  }
}

/* MODAL & HISTORY */
function openModal(id=null, viewHistoryOnly=false){
  editingId = id;
  if(id){
    const p = projects.find(x=>x.id===id);
    if(!p) return;
    modalTitle.textContent = (viewHistoryOnly? 'History for ' : 'Edit ') + p.name;
    f_name.value = p.name; f_status.value = p.status; f_version.value = p.version; f_progress.value = p.progress||0; f_notes.value = p.notes||'';
    renderHistory(p.history);
  } else {
    modalTitle.textContent = 'Create new project'; f_name.value=''; f_status.value='in-development'; f_version.value='0.1.0'; f_progress.value=10; f_notes.value=''; historyList.innerHTML='';
  }

  // disable fields if viewHistoryOnly or not unlocked
  const locked = viewHistoryOnly || !unlocked;
  modalSave.disabled = locked;
  f_name.disabled = locked;
  f_status.disabled = locked;
  f_version.disabled = locked;
  f_progress.disabled = locked;
  f_notes.disabled = locked;

  modalBackdrop.classList.add('show');
  modalBackdrop.setAttribute('aria-hidden','false');

  // prevent editing while in history-only (trap typing)
  if(viewHistoryOnly){
    modalBackdrop.addEventListener('keydown', preventTypingWhileHistory);
  } else {
    modalBackdrop.removeEventListener('keydown', preventTypingWhileHistory);
  }

  // focus first editable field if editing
  setTimeout(()=>{ if(!locked) f_name.focus(); }, 200);
}

function closeModal(){
  modalBackdrop.classList.remove('show');
  modalBackdrop.setAttribute('aria-hidden','true');
  editingId = null;
  modalBackdrop.removeEventListener('keydown', preventTypingWhileHistory);
}

function preventTypingWhileHistory(e){
  const blocked = ['Backspace','Delete'];
  if(blocked.includes(e.key)){ e.preventDefault(); return; }
  if(e.ctrlKey || e.metaKey) return;
  if(e.key.length === 1) e.preventDefault();
}

function renderHistory(arr){
  historyList.innerHTML = '';
  (arr||[]).slice().reverse().forEach(h=>{
    const el = document.createElement('div'); el.className='history-item';
    const action = escapeHtml(h.action || 'change');
    const who = escapeHtml(h.who || '—');
    const when = new Date(h.when).toLocaleString();
    const snap = escapeHtml(JSON.stringify(h.snapshot||{}, null, 2));
    el.innerHTML = `<div style="font-weight:700;color:var(--text)">${action}</div><div style="font-size:12px;color:var(--muted)">${when} — ${who}</div><div style="margin-top:6px;font-size:13px">Snapshot:<pre>${snap}</pre></div>`;
    el.querySelectorAll('pre').forEach(p => p.contentEditable = 'false');
    historyList.appendChild(el);
  });
  if(!(arr||[]).length) historyList.innerHTML = '<div class="note">No history yet for this project.</div>';
}

/* MODAL BUTTONS */
modalCancel.addEventListener('click', ()=> closeModal());
modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });

modalSave.addEventListener('click', ()=>{
  const name = f_name.value.trim(); if(!name){ alert('Name required'); return; }
  const status = f_status.value; const version = f_version.value.trim(); const progress = Number(f_progress.value)||0; const notes = f_notes.value.trim();
  if(editingId){
    saveUndoSnapshot();
    const p = projects.find(x=>x.id===editingId);
    if(!p) return;
    const old = JSON.parse(JSON.stringify(p));
    p.name = name; p.status = status; p.version = version; p.progress = progress; p.notes = notes; p.tags = p.tags || [];
    p.history = p.history || []; p.history.push({when:Date.now(), who:'editor', action:'updated', snapshot:old});
  } else {
    saveUndoSnapshot();
    const id = slugify(name) || uid();
    const newP = { id, name, status, version, progress, notes, tags:[], createdAt:Date.now(), history:[{when:Date.now(),who:'editor',action:'created'}] };
    projects.unshift(newP);
  }
  persist(); closeModal();
});

/* UNLOCK / LOCK */
unlockBtn.addEventListener('click', ()=>{
  if(unlocked){
    unlocked = false;
    sessionStorage.removeItem(LS_UNLCK);
    render();
    return;
  }
  const val = prompt('Enter passkey to unlock edit mode:');
  if(val === PASSKEY){
    unlocked = true; sessionStorage.setItem(LS_UNLCK, '1'); alert('Unlocked — you may now edit.');
    render();
  } else {
    alert('Incorrect passkey.');
  }
});

/* ADD NEW */
addNewBtn.addEventListener('click', ()=> {
  if(!unlocked){ alert('Unlock first to create or edit projects.'); return; }
  openModal(null,false);
});

/* SEARCH */
searchInput.addEventListener('input', ()=> render());

/* EXPORT / IMPORT (gated) */
function exportData(){
  const data = JSON.stringify({ exportedAt:Date.now(), projects }, null, 2);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dev-diary-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
exportBtn.addEventListener('click', ()=> { if(!unlocked) return; exportData(); });
exportHead.addEventListener('click', ()=> { if(!unlocked) return; exportData(); });

importBtn.addEventListener('click', ()=> { if(!unlocked) return; fileInput.click(); });
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    if(!parsed.projects) throw new Error('Invalid file format');
    if(!confirm('Import will replace current projects. Continue?')) return;
    saveUndoSnapshot(); projects = parsed.projects; persist(); alert('Import complete.');
  } catch(err){ alert('Import failed: ' + err.message); }
  fileInput.value = '';
});

/* UNDO & RESET (gated) */
undoBtn.addEventListener('click', ()=> {
  if(!unlocked) return;
  if(!undoStack || !undoStack.length){ alert('Nothing to undo'); return; }
  const prev = undoStack.pop(); projects = prev; saveJSON(LS_UNDO, undoStack); persist(); alert('Reverted last change');
});

resetBtn.addEventListener('click', ()=> {
  if(!unlocked) return;
  if(!confirm('Reset to default seeded projects? This will overwrite current projects.')) return;
  saveUndoSnapshot(); projects = JSON.parse(JSON.stringify(DEFAULT_PROJECTS)); persist(); alert('Reset complete.');
});

/* UNDO VIEWER */
undoViewerBtn.addEventListener('click', ()=>{
  if(!unlocked) return;
  // show last 6 entries
  const entries = (undoStack||[]).slice(-6).reverse();
  const text = entries.length ? entries.map((e,i)=>`${i+1}. ${e.length} projects — ${new Date().toLocaleString()}`).join('\n') : 'No undo history';
  alert('Undo stack (most recent first):\n\n' + text);
});

/* REORDER */
function moveProject(id, dir){
  const idx = projects.findIndex(p=>p.id===id); if(idx===-1) return; const to = idx+dir; if(to<0||to>=projects.length) return;
  saveUndoSnapshot(); const [itm] = projects.splice(idx,1); projects.splice(to,0,itm); persist();
}

/* SORTING (click header) */
document.querySelectorAll('thead th[data-key]').forEach(th=>{
  th.addEventListener('click', ()=> {
    const key = th.getAttribute('data-key');
    if(sortState.key === key) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
    else { sortState.key = key; sortState.dir = 'asc'; }
    // UI indicator
    document.querySelectorAll('thead th').forEach(x=> x.classList.remove('sort-asc','sort-desc'));
    th.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    render();
  });
});

/* RESIZABLE SIDEBAR */
let isResizing = false;
divider.addEventListener('mousedown', (e)=>{ isResizing=true; document.body.style.cursor='col-resize'; });
window.addEventListener('mouseup', ()=>{ if(isResizing){ isResizing=false; document.body.style.cursor=''; layout.sidebarWidth = parseInt(sidebar.getBoundingClientRect().width); saveLayout(); }});
window.addEventListener('mousemove', (e)=>{ if(!isResizing) return; const left = document.querySelector('.app').getBoundingClientRect().left; let w = e.clientX - left; if(w < 200) w = 200; if(w > 540) w = 540; layout.sidebarWidth = w; sidebar.style.width = w+'px'; });

/* SIDEBAR TOGGLE (mobile) */
sidebarToggle.addEventListener('click', ()=>{
  if(window.innerWidth <= 900){
    sidebar.classList.toggle('hidden');
    sidebar.classList.toggle('overlay');
  } else {
    layout.sidebarCollapsed = !layout.sidebarCollapsed;
    saveLayout();
    applyLayout();
  }
});

/* COMPACT MODE TOGGLE */
compactToggle.addEventListener('click', ()=>{
  layout.compact = !layout.compact; saveLayout(); applyLayout();
});

/* KEYBOARD SHORTCUTS */
window.addEventListener('keydown', (e)=>{
  // Ctrl/Cmd+F -> focus search
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f'){ e.preventDefault(); searchInput.focus(); return; }
  // Ctrl/Cmd+N -> new project (if unlocked)
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n'){ e.preventDefault(); if(unlocked) openModal(null,false); else alert('Unlock to create new projects.'); return; }
  // Escape closes modal
  if(e.key === 'Escape'){ if(modalBackdrop.classList.contains('show')) closeModal(); }
});

/* MOBILE SWIPE (basic left/right to toggle sections) */
let touchStartX = 0;
main.addEventListener('touchstart', (e)=> { touchStartX = e.touches[0].clientX; });
main.addEventListener('touchend', (e)=> {
  const dx = e.changedTouches[0].clientX - touchStartX;
  if(Math.abs(dx) < 60) return;
  if(dx > 0){ /* swipe right */ if(window.innerWidth <= 900){ sidebar.classList.remove('hidden'); sidebar.classList.add('overlay'); } }
  else { /* swipe left */ if(window.innerWidth <= 900){ sidebar.classList.add('hidden'); } }
});

/* PERSISTED LAYOUT ON LOAD */
applyLayout();

/* INITIAL RENDER */
render();

/* expose debug helpers */
window.__devDiary = {
  get projects(){ return projects; },
  save: ()=> persist(),
  unlock: ()=> { sessionStorage.setItem(LS_UNLCK,'1'); unlocked=true; render(); }
};
</script>
</body>
</html>
